<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JARVIS</title>
<style>
  :root{
    --bg:#0f1117;--sidebar:#0b0f14;--panel:#111826;--panel-2:#0c1320;
    --accent:#10a37f;--accent-2:#1ea992;--text:#e6e7e9;--muted:#a0a8b8;--line:#1f2a3a;
    --user:#1b273a;--bot:#121a28;--radius:12px;--danger:#e05260;
  }
  :root[data-theme="light"]{
    --bg:#f7f8fb; --sidebar:#f1f3f8; --panel:#ffffff; --panel-2:#f6f7fb;
    --accent:#0f9150; --accent-2:#0c7f45; --text:#0e1320; --muted:#4a5670; --line:#e2e6f0;
    --user:#e9eef9; --bot:#f4f6fb; --danger:#d04556;
  }
  /* light overrides (–∫—Ä–∞—Ç–∫–æ) */
  :root[data-theme="light"] .side{ border-right-color:#d7deec; }
  :root[data-theme="light"] .head{ background:linear-gradient(180deg,#f5f8ff,transparent); border-bottom-color:#d7deec; }
  :root[data-theme="light"] .composer{ background:linear-gradient(0deg,#f6f8ff,transparent); border-top-color:#d7deec; }
  :root[data-theme="light"] .btn{ background:#e7ecf6; border-color:#c9d4ea; color:#0e1320; }
  :root[data-theme="light"] .tab{ background:#eef2fb; border-color:#c9d4ea; color:#0e1320; }
  :root[data-theme="light"] .tab.active{ background:#dfe7ff; border-color:#a9bce8; color:#0e1320; }
  :root[data-theme="light"] .select{ background:#ffffff; border-color:#c9d4ea; color:#0e1320; }
  :root[data-theme="light"] .msgs{ background:#ffffff; }
  :root[data-theme="light"] .bubble{ background:#f7f9ff; border-color:#cfd8ea; color:#0e1320; }
  :root[data-theme="light"] .me .bubble{ background:#eaf2ff; border-color:#b7c8e8; }
  :root[data-theme="light"] .input{ background:#ffffff; border-color:#c9d4ea; color:#0e1320; }
  :root[data-theme="light"] .send{ background:var(--accent); color:#ffffff; }
  :root[data-theme="light"] .action{ background:#eef3ff; border-color:#c9d4ea; color:#0e1320; }
  :root[data-theme="light"] .linkcard{ background:#ffffff; border-color:#c9d4ea; }
  :root[data-theme="light"] .chip{ background:#eef2fb; border-color:#c9d4ea; color:#0e1320; }
  :root[data-theme="light"] .banner{ background:#fff4f6; border-color:#ffd4da; color:#601d28; }
  :root[data-theme="light"] .ibadge{background:#eef2fb;border-color:#c9d4ea;color:#0e1320}
  :root[data-theme="light"] .statusbar{background:#eef2fb;border-color:#c9d4ea;color:#0e1320}

  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .app{display:grid;grid-template-columns:260px 1fr;height:100vh}
  /* sidebar */
  .side{background:var(--sidebar);border-right:1px solid var(--line);display:flex;flex-direction:column}
  .side .top{padding:12px;border-bottom:1px solid var(--line);display:flex;gap:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--panel-2);color:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn:hover{filter:brightness(1.08)}
  .side .search{padding:10px 12px;border-bottom:1px solid var(--line)}
  .search input{width:100%;padding:8px 10px;border:1px solid #1c2942;border-radius:10px;background:#0d1626;color:#e6e7e9}
  :root[data-theme="light"] .search input{background:#fff;border-color:#c9d4ea;color:#0e1320}
  .chats{flex:1;overflow:auto;padding:8px}
  .sectionTitle{padding:6px 10px;color:#9fb2d3;font-size:11px;opacity:.9}
  .chat-item{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;padding:10px;border-radius:10px;border:1px solid transparent;cursor:pointer;color:var(--text)}
  .chat-item:hover{background:#0f1826;border-color:#152238}
  .chat-item.active{background:#0f1d2f;border-color:#1c2a44}
  .chat-title{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .chat-actions{display:flex;gap:8px;opacity:.8}
  .pin{cursor:pointer} .del{cursor:pointer}
  .side .foot{padding:10px;border-top:1px solid var(--line);display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px}
  .dot{width:8px;height:8px;border-radius:50%}
  .ok{background:#1ec27e} .off{background:#666} .warn{background:#f1c40f}

  /* main */
  .main{display:grid;grid-template-rows:auto 1fr auto}
  .head{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0e1726,transparent)}
  .brand{font-weight:600}
  .sep{flex:1}
  .select{background:#0d1626;border:1px solid #1c2942;border-radius:10px;padding:8px 10px;color:#e9eef9}
  .tabs{display:flex;gap:8px;margin-left:12px}
  .tab{padding:6px 10px;border:1px solid #1c2942;border-radius:10px;background:#0d1626;color:#cbd3e5;cursor:pointer}
  .tab.active{color:#fff;border-color:#2a385a;background:#14203a}
  .banner{display:none;align-items:center;gap:10px;margin:10px auto 0;max-width:820px;color:#fff;background:#2b1b22;border:1px solid #4a2b39;padding:8px 12px;border-radius:10px}
  .banner.on{display:flex}

  .msgs{padding:18px;overflow:auto;background:var(--panel)}
  .msg{max-width:820px;margin:0 auto 14px}
  .bubble{border-radius:16px;padding:12px 14px;border:1px solid #1c273b;background:var(--bot);white-space:pre-wrap;word-break:break-word;position:relative}
  .me .bubble{background:var(--user)}
  .meta{margin-top:6px;color:var(--muted);font-size:11px;display:flex;gap:8px;align-items:center}
  .ibadge{font-size:10px;line-height:1;padding:3px 6px;border-radius:999px;border:1px solid #2a3550;background:#0d1626;color:#cbd3e5}
  .actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .action{font-size:12px;text-decoration:none;color:#dfe7ff;background:#0d1626;border:1px solid #1c2942;border-radius:10px;padding:6px 10px}
  .typing{display:none;color:var(--muted);font-size:12px;margin:8px auto;max-width:820px}
  .typing.on{display:block}
  .panel{display:none;padding:16px}
  .panel.active{display:block}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;color:#cbd3e5}
  .linkcard{display:flex;align-items:center;gap:10px;background:#0d1626;border:1px solid #1c2942;border-radius:10px;padding:8px 10px;max-width:820px}
  .linkcard img{width:16px;height:16px;border-radius:3px}
  .linkcard .dom{font-size:12px;color:#cbd3e5}
  .linkcard .go{margin-left:auto;font-size:12px;color:#a4c0ff;text-decoration:none}
  .copy{position:absolute;top:8px;right:8px;background:#0d1626;border:1px solid #1c2942;border-radius:8px;color:#cbd3e5;font-size:12px;padding:4px 8px;cursor:pointer}
  .copy:hover{filter:brightness(1.1)}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0d1626;border:1px solid #1c2942;color:#e6e7e9;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s}
  .toast.on{opacity:1}
  .sugg{display:flex;gap:8px;flex-wrap:wrap;max-width:820px;margin:8px auto 0;padding:0 18px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:#0d1626;border:1px solid #1c2942;color:#cbd3e5;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}
  .chip:hover{filter:brightness(1.1)}

  .statusbar{max-width:820px;margin:6px auto 8px auto;padding:6px 10px;border-radius:10px;border:1px solid #1c2942;background:#0d1626;color:#cbd3e5;font-size:12px;display:none}
  .statusbar.on{display:block}
</style>
</head>
<body>
<div class="app">
  <!-- sidebar -->
  <aside class="side">
    <div class="top">
      <button id="newChat" class="btn">Ôºã –ù–æ–≤—ã–π —á–∞—Ç</button>
      <button id="profileBtn" class="btn">–ü—Ä–æ—Ñ–∏–ª—å</button>
    </div>
    <div class="search"><input id="chatFilter" placeholder="–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç–∞–º‚Ä¶"></div>
    <div id="chats" class="chats"></div>
    <div class="foot">
      <span id="dotOnline" class="dot off"></span><span id="txtOnline">offline</span>
      <span style="margin-left:auto"></span>
      <span id="dotWeb" class="dot off"></span><span id="txtWeb">search off</span>
    </div>
  </aside>

  <!-- main -->
  <main class="main">
    <div class="head">
      <div class="brand">JARVIS</div>
      <div class="tabs">
        <div class="tab active" data-tab="chat">–ß–∞—Ç</div>
        <div class="tab" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>
      <div class="sep"></div>
      <label style="font-size:12px;color:#a8b2c6">–°—Ç–∏–ª—å&nbsp;</label>
      <select id="styleSel" class="select">
        <option value="auto">auto</option>
        <option value="friendly">friendly</option>
        <option value="formal">formal</option>
      </select>
      <button id="themeBtn" class="btn" style="margin-left:8px">üåô –¢–µ–º–∞</button>
      <button id="intentBtn" class="btn" style="margin-left:8px">üéØ –ò–Ω—Ç–µ–Ω—Ç—ã: –≤—ã–∫–ª</button>
    </div>

    <div id="offlineBanner" class="banner"><span>üîå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. </span><button id="reconnect" class="btn">–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button></div>

    <div id="viewChat" class="panel active">
      <div id="msgs" class="msgs"></div>
      <div id="typing" class="typing">–ø–µ—á–∞—Ç–∞—é‚Ä¶</div>
      <div id="sugg" class="sugg"></div>
      <div id="statusbar" class="statusbar"></div>
    </div>

    <div id="viewProfile" class="panel">
      <div class="row"><b>–°–æ—Å—Ç–æ—è–Ω–∏–µ:</b> <span id="pfOnline" class="dot off"></span><span id="pfOnlineTxt">offline</span></div>
      <div class="row"><b>–í–µ–±-–ø–æ–∏—Å–∫:</b> <span id="pfWeb" class="dot off"></span><span id="pfWebTxt">off</span></div>
      <div class="row"><small>–≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —à–∞–≥–µ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω—è–ª ‚Ññ8).</small></div>
    </div>

    <div class="composer">
      <textarea id="input" class="input" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶" rows="1"></textarea>
      <button id="send" class="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </main>
</div>

<div id="toast" class="toast">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

<script>
if (location.protocol === 'file:') { alert('–û—Ç–∫—Ä–æ–π http://localhost:3000/ (–Ω–µ file://).'); }

/* theme */
function getTheme(){ try{return localStorage.getItem('jarvis.theme')||'dark';}catch{return 'dark';} }
function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); try{ localStorage.setItem('jarvis.theme', t); }catch{} if(themeBtn){ themeBtn.textContent = (t==='dark'?'üåô –¢–µ–º–∞':'‚òÄÔ∏è –¢–µ–º–∞'); } }

/* keys */
const SKEY='jarvis.chats.v1', DRAFTS='jarvis.drafts.v1', INTENT_KEY='jarvis.intent.debug';

/* state */
let chats = loadChats();
let drafts = loadDrafts();
let currentId = chats.length ? chats[0].id : createChat('–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥');

function loadChats(){ try{ return JSON.parse(localStorage.getItem(SKEY)) || []; }catch{ return []; } }
function saveChats(){ localStorage.setItem(SKEY, JSON.stringify(chats)); }
function loadDrafts(){ try{ return JSON.parse(localStorage.getItem(DRAFTS)) || {}; }catch{ return {}; } }
function saveDrafts(){ localStorage.setItem(DRAFTS, JSON.stringify(drafts)); }

function getIntentDebug(){ try{return localStorage.getItem(INTENT_KEY)==='1';}catch{return false;} }
function setIntentDebug(v){ try{ localStorage.setItem(INTENT_KEY, v?'1':'0'); }catch{} if (intentBtn) intentBtn.textContent = 'üéØ –ò–Ω—Ç–µ–Ω—Ç—ã: ' + (v?'–≤–∫–ª':'–≤—ã–∫–ª'); }

function createChat(title){
  const id = 'c_'+Date.now();
  chats.unshift({ id, title, msgs: [], pinned:false, updatedAt: Date.now() });
  saveChats(); renderChats();
  return id;
}
function touchChat(id){
  const c = chats.find(x=>x.id===id); if(c){ c.updatedAt = Date.now(); saveChats(); }
}
function setActive(id){
  setDraft(currentId, elInput.value);
  currentId=id; renderChats(); renderMsgs();
  elInput.value = getDraft(currentId); autoGrow(elInput); renderSugg();
}
function getDraft(id){ return drafts[id] || ''; }
function setDraft(id, text){ drafts[id] = text || ''; saveDrafts(); }

/* elements */
const elChats=document.getElementById('chats'); const elMsgs=document.getElementById('msgs'); const elTyping=document.getElementById('typing');
const elInput=document.getElementById('input'); const elSend=document.getElementById('send'); const elStyle=document.getElementById('styleSel');
const profileBtn=document.getElementById('profileBtn'); const themeBtn=document.getElementById('themeBtn'); const intentBtn=document.getElementById('intentBtn');
const dotOn=document.getElementById('dotOnline'), txtOn=document.getElementById('txtOnline'); const dotWeb=document.getElementById('dotWeb'), txtWeb=document.getElementById('txtWeb');
const pfOn=document.getElementById('pfOnline'), pfOnTxt=document.getElementById('pfOnlineTxt'); const pfWeb=document.getElementById('pfWeb'), pfWebTxt=document.getElementById('pfWebTxt');
const tabs=document.querySelectorAll('.tab'); const viewChat=document.getElementById('viewChat'); const viewProfile=document.getElementById('viewProfile');
const banner=document.getElementById('offlineBanner'); const btnReconnect=document.getElementById('reconnect'); const toast=document.getElementById('toast');
const sugg=document.getElementById('sugg'); const statusbar=document.getElementById('statusbar'); const chatFilter=document.getElementById('chatFilter');

function switchTab(name){ tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===name)); viewChat.classList.toggle('active', name==='chat'); viewProfile.classList.toggle('active', name==='profile'); }
tabs.forEach(t => t.onclick = ()=> switchTab(t.dataset.tab));
profileBtn.onclick = ()=> switchTab('profile');
if(themeBtn){ themeBtn.onclick = ()=>{ const next=(getTheme()==='dark'?'light':'dark'); applyTheme(next); }; }
if(intentBtn){ intentBtn.onclick=()=>{ setIntentDebug(!getIntentDebug()); renderMsgs(); }; }

function setDot(el, state){ el.className='dot '+(state||'off'); }
function fmtTime(d=new Date()){ return d.toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}); }
function showToast(msg='–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'){ toast.textContent=msg; toast.classList.add('on'); setTimeout(()=>toast.classList.remove('on'),1200); }
function setStatus(text){ if(!text){ statusbar.classList.remove('on'); statusbar.textContent=''; return; } statusbar.textContent=text; statusbar.classList.add('on'); }

/* list rendering */
function renderChats(){
  elChats.innerHTML='';

  // —Ñ–∏–ª—å—Ç—Ä
  const q = (chatFilter.value||'').toLowerCase().trim();
  const filtered = chats.filter(c=>{
    if(!q) return true;
    return (c.title||'').toLowerCase().includes(q) || (c.msgs||[]).some(m=> (m.text||'').toLowerCase().includes(q));
  });

  // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: pinned desc, updatedAt desc
  filtered.sort((a,b)=>{
    if ((b.pinned?1:0)!==(a.pinned?1:0)) return (b.pinned?1:0)-(a.pinned?1:0);
    return (b.updatedAt||0)-(a.updatedAt||0);
  });

  // —Å–µ–∫—Ü–∏–∏: –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ / –û—Å—Ç–∞–ª—å–Ω—ã–µ
  const pinned = filtered.filter(c=>c.pinned);
  const others = filtered.filter(c=>!c.pinned);

  function addSection(title, items){
    if(!items.length) return;
    const h = document.createElement('div'); h.className='sectionTitle'; h.textContent = title;
    elChats.appendChild(h);
    items.forEach(c=>{
      const row=document.createElement('div'); row.className='chat-item'+(c.id===currentId?' active':'');
      row.onclick=()=> setActive(c.id);

      const titleEl=document.createElement('div'); titleEl.className='chat-title'; titleEl.textContent=c.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

      const pin=document.createElement('span'); pin.className='pin'; pin.title = c.pinned?'–û—Ç–∫—Ä–µ–ø–∏—Ç—å':'–ó–∞–∫—Ä–µ–ø–∏—Ç—å';
      pin.textContent = c.pinned ? 'üìå' : 'üìç';
      pin.onclick=(e)=>{ e.stopPropagation(); c.pinned=!c.pinned; saveChats(); renderChats(); };

      const del=document.createElement('span'); del.className='del'; del.title='–£–¥–∞–ª–∏—Ç—å'; del.textContent='‚úï';
      del.onclick=(e)=>{ e.stopPropagation(); delete drafts[c.id]; saveDrafts(); chats = chats.filter(x=>x.id!==c.id); if(currentId===c.id) currentId = chats[0]?.id || createChat('–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥'); saveChats(); renderChats(); renderMsgs(); elInput.value=getDraft(currentId); autoGrow(elInput); renderSugg(); };

      row.appendChild(titleEl);
      row.appendChild(pin);
      row.appendChild(del);
      elChats.appendChild(row);
    });
  }

  addSection('–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ', pinned);
  addSection('–û—Å—Ç–∞–ª—å–Ω—ã–µ', others);
}

/* linkcard */
function makeLinkCard(urlStr){ try{ const u=new URL(urlStr); const dom=u.hostname.replace(/^www\./,''); const fav='https://www.google.com/s2/favicons?sz=64&domain='+u.hostname; const card=document.createElement('div'); card.className='linkcard'; const img=document.createElement('img'); img.src=fav; const span=document.createElement('span'); span.className='dom'; span.textContent=dom; const a=document.createElement('a'); a.href=urlStr; a.target='_blank'; a.className='go'; a.textContent='–û—Ç–∫—Ä—ã—Ç—å'; card.appendChild(img); card.appendChild(span); card.appendChild(a); return card; }catch{ return null; } }

/* render messages */
function getIntentDebug(){ try{return localStorage.getItem(INTENT_KEY)==='1';}catch{return false;} }
function renderMsgs(){
  const chat=chats.find(c=>c.id===currentId); elMsgs.innerHTML=''; if(!chat) return;
  const showIntent=getIntentDebug();
  chat.msgs.forEach(m=>{
    const wrap=document.createElement('div'); wrap.className='msg '+(m.who==='user'?'me':'bot');
    const bubble=document.createElement('div'); bubble.className='bubble'; bubble.textContent=m.text||'‚Äî';
    if(m.who==='bot'){ const copy=document.createElement('button'); copy.className='copy'; copy.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; copy.onclick=async()=>{ try{ await navigator.clipboard.writeText(m.text||''); showToast(); }catch{ showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); } }; bubble.appendChild(copy); }
    wrap.appendChild(bubble);
    if(m.actions?.length){ const actWrap=document.createElement('div'); actWrap.className='actions';
      m.actions.forEach(a=>{ if(a.type==='open_url' && a.url){ const card=makeLinkCard(a.url); if(card) actWrap.appendChild(card); else { const link=document.createElement('a'); link.href=a.url; link.target='_blank'; link.className='action'; link.textContent='–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É'; actWrap.appendChild(link); } } });
      wrap.appendChild(actWrap);
    }
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=fmtTime(new Date(m.ts||Date.now()));
    if (showIntent && m.who==='bot' && m.intent){ const b=document.createElement('span'); b.className='ibadge'; b.textContent=m.intent; meta.appendChild(document.createTextNode(' ¬∑ ')); meta.appendChild(b); }
    wrap.appendChild(meta);
    elMsgs.appendChild(wrap);
  });
  elMsgs.scrollTop = elMsgs.scrollHeight;
}

/* meta/status */
let lastMeta={online:false, web:false};
async function refreshMeta(){
  try{
    const r=await fetch('/api/meta',{cache:'no-store'}); const m=await r.json(); const online=m.status==='online';
    lastMeta={online, web:!!m.web_search_enabled};
    setDot(dotOn, online?'ok':'off'); txtOn.textContent= online?'online':'offline';
    setDot(dotWeb, m.web_search_enabled?'ok':'off'); txtWeb.textContent= m.web_search_enabled?'search on':'search off';
    setDot(pfOn, online?'ok':'off'); pfOnTxt.textContent= online?'online':'offline';
    setDot(pfWeb, m.web_search_enabled?'ok':'off'); pfWebTxt.textContent= m.web_search_enabled?'on':'off';
    banner.classList.remove('on'); elSend.disabled=false;
  }catch{
    lastMeta={online:false, web:false};
    setDot(dotOn,'off'); txtOn.textContent='offline'; setDot(dotWeb,'off'); txtWeb.textContent='search off';
    setDot(pfOn,'off'); pfOnTxt.textContent='offline'; setDot(pfWeb,'off'); pfWebTxt.textContent='off';
    banner.classList.add('on'); elSend.disabled=false;
  }
}

/* suggestions */
function suggSet(){
  const base=[{t:"—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏",send:true},{t:"–ø–æ–≥–æ–¥–∞ –≤ –¢–æ–∫–∏–æ",send:true},{t:"—Ç—Ä–µ–Ω–¥—ã —Ç–∏–∫—Ç–æ–∫–∞",send:true},{t:"—Å–∏—Ç—É–∞—Ü–∏—è –Ω–∞ —É–∫—Ä–∞–∏–Ω–µ",send:true},{t:"–ø–æ–≥–æ–¥–∞ –≤ –ù—å—é-–ô–æ—Ä–∫–µ",send:true},{t:"–∫–∞–∫ –¥–µ–ª–∞?",send:true}];
  const offline=[{t:"–ø—Ä–∏–≤–µ—Ç",send:true},{t:"—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏",send:true},{t:"–∫–∞–∫ –¥–µ–ª–∞?",send:true}];
  if(!lastMeta.online || !lastMeta.web) return offline;
  const chat=chats.find(c=>c.id===currentId); const lastU=chat?.msgs?.slice().reverse().find(m=>m.who==='user')?.text?.toLowerCase()||'';
  if(lastU.includes('–ø–æ–≥–æ–¥')) return [{t:"–ø–æ–≥–æ–¥–∞ –≤ –ü–∞—Ä–∏–∂–µ",send:true},{t:"–ø–æ–≥–æ–¥–∞ –≤ –ú–∏–ª–∞–Ω–µ",send:true},{t:"–ø–æ–≥–æ–¥–∞ –≤ –†–∏–º–µ",send:true}];
  if(lastU.includes('—Ç—Ä–µ–Ω–¥')||lastU.includes('–Ω–æ–≤–æ—Å—Ç')) return [{t:"—Ç—Ä–µ–Ω–¥—ã —Ç–∏–∫—Ç–æ–∫–∞",send:true},{t:"–Ω–æ–≤–æ—Å—Ç–∏ —Å–µ–≥–æ–¥–Ω—è",send:true},{t:"—á—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ–π—á–∞—Å?",send:true}];
  return base;
}
function renderSugg(){ const items=suggSet(); sugg.innerHTML=''; items.forEach(it=>{ const c=document.createElement('button'); c.className='chip'; c.textContent=it.t; c.onclick=()=>{ elInput.value=it.t; autoGrow(elInput); if(it.send) send(); }; sugg.appendChild(c); }); }

/* sending */
function addMsg(who,text,actions,intent){
  const chat=chats.find(c=>c.id===currentId); if(!chat) return;
  chat.msgs.push({who,text,actions:actions||[],intent:intent||"",ts:Date.now()});
  if (who==='user' && (!chat.title || chat.title==='–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥')) chat.title=(text||'–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥').slice(0,40);
  chat.updatedAt = Date.now();
  saveChats(); renderMsgs(); renderChats();
}
async function send(){
  const text=elInput.value.trim(); if(!text) return;
  addMsg('user',text); setDraft(currentId,''); elInput.value=''; autoGrow(elInput);
  elTyping.classList.add('on'); elSend.disabled=true; setStatus('‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å‚Ä¶');
  const t0=performance.now();
  try{
    const res=await fetch('/api/assist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:text, styleLock: elStyle.value})});
    const data=await res.json();
    elTyping.classList.remove('on'); elSend.disabled=false;
    addMsg('bot', data.reply || '‚Äî', data.actions||[], data.intent||"");
    const took = (data.meta?.tookMs ?? (performance.now()-t0)).toFixed(0);
    const provider = data.meta?.provider || 'local';
    const ok = (data.meta?.ok !== false);
    setStatus(`${ok?'‚úÖ':'‚ö†Ô∏è'} ‚è± ${took} –º—Å ¬∑ –∏—Å—Ç–æ—á–Ω–∏–∫: ${provider} ¬∑ –∏–Ω—Ç–µ–Ω—Ç: ${data.intent||'-'}`);
  }catch(e){
    elTyping.classList.remove('on'); elSend.disabled=false;
    addMsg('bot','‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ—Ç–∫—Ä—ã—Ç http://localhost:3000/ –∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.',[], "ERROR");
    banner.classList.add('on'); setStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏/—Å–µ—Ä–≤–µ—Ä–∞');
  } finally {
    renderSugg();
  }
}

/* utils & hooks */
function autoGrow(t){ t.style.height='auto'; t.style.height=Math.min(160,Math.max(44,t.scrollHeight))+'px'; }
document.getElementById('send').onclick=send;
document.getElementById('input').addEventListener('keydown',e=>{ autoGrow(e.target); if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }});
document.getElementById('input').addEventListener('input',e=>{ autoGrow(e.target); setDraft(currentId,e.target.value); });
document.getElementById('newChat').onclick=()=> setActive(createChat('–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥'));
document.getElementById('reconnect').onclick=refreshMeta;
document.getElementById('chatFilter').addEventListener('input', ()=> renderChats());

/* init */
applyTheme(getTheme()); setIntentDebug(getIntentDebug());
renderChats(); renderMsgs(); refreshMeta();
const helloMsg='–ü—Ä–∏–≤–µ—Ç! –Ø –Ω–∞ —Å–≤—è–∑–∏. –°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å üòâ';
(function firstHello(){ const chat=chats.find(c=>c.id===currentId); if(!chat||!chat.msgs||chat.msgs.length===0){ addMsg('bot',helloMsg,[], "GREETING"); }})();
elInput.value=getDraft(currentId); autoGrow(elInput); renderSugg();
</script>
</body>
</html>
