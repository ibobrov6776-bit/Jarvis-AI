import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import path from "path";
import { fileURLToPath } from "url";
import { fetch } from "undici";

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, "public")));

const BRAVE_KEY = (process.env.BRAVE_KEY || "").trim();
const PORT = process.env.PORT || 3000;

/* ---------- –£—Ç–∏–ª–∏—Ç—ã ---------- */
function normalizeText(text) {
  const dict = {
    "—á–µ":"—á—Ç–æ","—á–æ":"—á—Ç–æ","—à–æ":"—á—Ç–æ","–∏–∑–∏":"–ª–µ–≥–∫–æ","—Ç–æ–ø—á–∏–∫":"–æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ",
    "–≤–∏–¥–æ—Å":"–≤–∏–¥–µ–æ","–≥–æ":"–¥–∞–≤–∞–π","–ª—é—Ç—ã–π":"–æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π","–∫–∞–∫ –∂–∏–∑–Ω—å":"–∫–∞–∫ –¥–µ–ª–∞"
  };
  let norm = (text || "").toLowerCase().trim();
  for (const [slang, normal] of Object.entries(dict)) {
    norm = norm.replace(new RegExp(`\\b${slang}\\b`, "gi"), normal);
  }
  return norm;
}

function detectStyleAuto(text) {
  const t = (text || "").toLowerCase();
  const isShort = t.split(/\s+/).filter(Boolean).length <= 6;
  const hasSlang = /(—á–µ|—á–æ|–∏–∑–∏|—Ç–æ–ø—á–∏–∫|–≥–æ|–Ω–æ—Ä–º–∞—Å|–ª—é—Ç—ã–π|—á–µ–ª|–±—Ä–æ|–ª–æ–ª|–∞—Ö–∞—Ö)/.test(t);
  const polite = /(–ø–æ–∂–∞–ª—É–π—Å—Ç–∞|–Ω–µ –º–æ–≥–ª–∏ –±—ã|–±—É–¥—å—Ç–µ –¥–æ–±—Ä—ã|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ)/.test(t) || /\b–≤—ã\b/.test(t);
  if (polite && !hasSlang) return "formal";
  if (hasSlang || isShort) return "friendly";
  return "formal";
}
function applyStyleLock(autoStyle, styleLock) {
  if (styleLock === "friendly" || styleLock === "formal") return styleLock;
  return autoStyle; // 'auto'
}
function isAscii(str) { return typeof str === "string" && /^[\x00-\x7F]*$/.test(str); }

/* ---------- –î–µ—Ç–µ–∫—Ç–æ—Ä –Ω–∞–º–µ—Ä–µ–Ω–∏—è ---------- */
function detectIntent(query) {
  const q = normalizeText(query);
  if (!q) return "EMPTY";

  if (/(^|\s)(–ø—Ä–∏–≤–µ—Ç|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ|–π–æ|—Ö–∞–π|–ø—Ä–∏–≤|–¥–∞—Ä–æ–≤–∞)\b/.test(q)) return "GREETING";
  if (/(–∫–∞–∫ –¥–µ–ª–∞|—á—Ç–æ –Ω–æ–≤–æ–≥–æ|–∫–∞–∫ —Ç—ã|–∫–∞–∫ –∂–∏–∑–Ω—å)/.test(q)) return "HOW_ARE_YOU";
  if (/\b(–≤—Ä–µ–º—è|–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å|—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º—è|—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏)\b/.test(q)) return "TIME";
  if (/\b(—Å–ø–∞—Å–∏–±–æ|–±–ª–∞–≥–æ–¥–∞—Ä—é|–º–µ—Ä—Å–∏)\b/.test(q)) return "THANKS";
  if (/\b(–ø–æ–∫–∞|–¥–æ –≤—Å—Ç—Ä–µ—á–∏|—É–≤–∏–¥–∏–º—Å—è|–±–∞–π)\b/.test(q)) return "BYE";

  if (/(–Ω–æ–≤–æ—Å—Ç–∏|—Ç—Ä–µ–Ω–¥—ã|—Å–∏—Ç—É–∞—Ü–∏—è|–æ–±—ä—è—Å–Ω–∏|—Ä–∞—Å—Å–∫–∞–∂–∏( –ø—Ä–æ| –æ–±)?|–Ω–∞–π–¥–∏|–ø–æ–∏—â–∏|google|–≤ –≥—É–≥–ª–µ|–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ|–±—Ä–∞—É–∑–µ—Ä)/.test(q)) {
    return "WEB_SEARCH";
  }
  const isQuestion = /(\?|–∫—Ç–æ|—á—Ç–æ|–≥–¥–µ|–∫–æ–≥–¥–∞|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º|–∫–∞–∫)\b/.test(q);
  if (isQuestion && q.split(/\s+/).length >= 4) return "WEB_SEARCH";

  if (q.split(/\s+/).length <= 3) return "SMALL_TALK";

  return "GENERAL_CHAT";
}

/* ---------- Brave Search ---------- */
async function braveSearch(q) {
  if (!BRAVE_KEY || !isAscii(BRAVE_KEY)) {
    return { disabled: true, items: [] };
  }
  const url = `https://api.search.brave.com/res/v1/web/search?q=${encodeURIComponent(q)}&count=3&freshness=day`;
  const res = await fetch(url, { headers: { "X-Subscription-Token": BRAVE_KEY } });
  if (!res.ok) {
    const body = await res.text().catch(()=> "");
    throw new Error(`Brave API ${res.status}: ${body}`);
  }
  const data = await res.json();
  const items = (data.web?.results ?? []).map(r => ({
    title: r.title, url: r.url, snippet: r.snippet || r.description || ""
  }));
  return { disabled: false, items };
}

/* ---------- Health / Meta ---------- */
app.get("/healthz", (_req,res)=>res.json({ok:true,time:new Date().toISOString()}));
app.get("/api/meta", (_req,res)=>res.json({
  capabilities:[
    "–í–µ–±-–ø–æ–∏—Å–∫ (–Ω–æ–≤–æ—Å—Ç–∏, —Ç—Ä–µ–Ω–¥—ã, –ø–æ–ª–∏—Ç–∏–∫–∞) ‚Äî –æ–¥–∏–Ω —á—ë—Ç–∫–∏–π –æ—Ç–≤–µ—Ç + —Å—Å—ã–ª–∫–∞",
    "–ü–æ–Ω–∏–º–∞–Ω–∏–µ —Å–ª–µ–Ω–≥–∞ –∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ñ—Ä–∞–∑",
    "–ê–≤—Ç–æ-—Å—Ç–∏–ª—å: –¥—Ä—É–∂–µ—Å–∫–∏–π –∏–ª–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π (–º–æ–∂–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å)",
    "–õ–æ–∫–∞–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã: –ø—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞, –≤—Ä–µ–º—è, —Å–ø–∞—Å–∏–±–æ, –ø–æ–∫–∞"
  ],
  status:"online",
  web_search_enabled: !!(BRAVE_KEY && isAscii(BRAVE_KEY))
}));

/* ---------- –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç ---------- */
app.post("/api/assist", async (req,res)=>{
  try{
    const query = (req.body?.query || "").trim();
    const styleLock = (req.body?.styleLock || "auto");
    if (!query) return res.status(400).json({ reply: "–ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å.", style: "formal", actions: [] });

    const intent = detectIntent(query);
    const autoStyle = detectStyleAuto(query);
    const style = applyStyleLock(autoStyle, styleLock);

    if (intent === "GREETING") {
      const text = style === "friendly" ? "–ô–æ! üëã –†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å üòé" : "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!";
      return res.json({ reply: text, style, actions: [] });
    }

    if (intent === "HOW_ARE_YOU") {
      const text = style === "friendly"
        ? "–î–∞ –Ω–æ—Ä–º–∞—Å, –≤—Å—ë —á—ë—Ç–∫–æ üòé –ê —É —Ç–µ–±—è –∫–∞–∫?"
        : "–£ –º–µ–Ω—è –≤—Å—ë —Ö–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ. –ö–∞–∫ —É –≤–∞—Å –¥–µ–ª–∞?";
      return res.json({ reply: text, style, actions: [] });
    }

    if (intent === "TIME") {
      const now = new Date().toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});
      const text = style === "friendly" ? `–ë—Ä–æ, —Å–µ–π—á–∞—Å ${now} üòâ` : `–°–µ–π—á–∞—Å ${now}.`;
      return res.json({ reply: text, style, actions: [] });
    }

    if (intent === "THANKS") {
      const text = style === "friendly" ? "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üôå" : "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞.";
      return res.json({ reply: text, style, actions: [] });
    }

    if (intent === "BYE") {
      const text = style === "friendly" ? "–î–æ —Å–≤—è–∑–∏! üëã" : "–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!";
      return res.json({ reply: text, style, actions: [] });
    }

    if (intent === "SMALL_TALK") {
      const text = style === "friendly"
        ? "–ü–æ–Ω—è–ª üëç –°–ø—Ä–æ—Å–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ."
        : "–ü–æ–Ω–∏–º–∞—é. –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.";
      return res.json({ reply: text, style, actions: [] });
    }

    if (intent === "GENERAL_CHAT") {
      const text = style === "friendly"
        ? "–û–∫–µ–π, –ø–æ–Ω—è–ª —Ç–µ–±—è. –ú–æ–≥—É –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–∫—Ç–æ–≤ –∏–ª–∏ —Å—Å—ã–ª–æ–∫, –µ—Å–ª–∏ –Ω–∞–¥–æ üòâ"
        : "–ü–æ–Ω–∏–º–∞—é. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–≥—É –¥–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É –∏–ª–∏ —Å—Å—ã–ª–∫–∏.";
      return res.json({ reply: text, style, actions: [] });
    }

    // WEB_SEARCH
    const clean = normalizeText(query);
    const { disabled, items } = await braveSearch(clean);
    if (disabled) {
      const msg = style==="friendly"
        ? "–ü–æ–∏—Å–∫ –≤ —Å–µ—Ç–∏ –≤—ã–∫–ª—é—á–µ–Ω (–Ω–µ—Ç/–Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á)."
        : "–ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–µ—Ç/–Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á).";
      return res.json({ reply: msg, style, actions: [] });
    }
    if (!items.length) {
      const msg = style==="friendly" ? `–ù–µ –Ω–∞—à—ë–ª –Ω–∏—á–µ–≥–æ –ø–æ ¬´${query}¬ª üòÖ` : `–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É ¬´${query}¬ª.`;
      return res.json({ reply: msg, style, actions: [] });
    }

    const top = items[0];
    const reply = style==="friendly"
      ? `–í–æ—Ç —á—Ç–æ –Ω–∞—à—ë–ª –ø–æ ¬´${query}¬ª: ${top.snippet || "–∏–Ω—Ñ—ã –º–∞–ª–æ–≤–∞—Ç–æ"}\nüëâ ${top.url}`
      : `–ü–æ –∑–∞–ø—Ä–æ—Å—É ¬´${query}¬ª: ${top.snippet || "–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}\n–ü–æ–¥—Ä–æ–±–Ω–µ–µ: ${top.url}`;

    return res.json({ reply, style, actions: [{ type:"open_url", url: top.url }] });

  } catch(e) {
    console.error("‚ùå /api/assist error:", e);
    return res.status(500).json({ reply:"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.", style:"formal", actions:[] });
  }
});

/* ---------- –ó–∞–ø—É—Å–∫ ---------- */
app.listen(PORT, ()=> {
  console.log(`‚úÖ Server ready: http://localhost:${PORT}`);
  console.log(`üîé Health:  http://localhost:${PORT}/healthz`);
  console.log(`‚ÑπÔ∏è  Meta:    http://localhost:${PORT}/api/meta`);
});
