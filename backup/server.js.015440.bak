import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import path from "path";
import { fileURLToPath } from "url";
import { fetch } from "undici";

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, "public")));

const PORT = process.env.PORT || 3000;

/* ---------- helpers ---------- */
const B = `[\\s.,!?:;"'¬´¬ª()\\-]`;
function normalizeText(text) {
  const dict = { "—á–µ":"—á—Ç–æ","—á–æ":"—á—Ç–æ","—à–æ":"—á—Ç–æ","–∏–∑–∏":"–ª–µ–≥–∫–æ","—Ç–æ–ø—á–∏–∫":"–æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ","–≤–∏–¥–æ—Å":"–≤–∏–¥–µ–æ","–≥–æ":"–¥–∞–≤–∞–π","–ª—é—Ç—ã–π":"–æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–π","–∫–∞–∫ –∂–∏–∑–Ω—å":"–∫–∞–∫ –¥–µ–ª–∞" };
  let norm = (text || "").toLowerCase().trim();
  for (const [slang, normal] of Object.entries(dict)) {
    norm = norm.replace(new RegExp(`(^|${B})${slang}(${B}|$)`, "gi"), `$1${normal}$2`);
  }
  return norm.replace(/\s+/g, " ");
}
function hasToken(str, token) { return new RegExp(`(^|${B})${token}(${B}|$)`,"i").test(str); }
function hasAnyToken(str, arr){ return arr.some(t => hasToken(str, t)); }
function hasPhrase(str, phrase){ return str.includes(phrase.toLowerCase()); }
function detectStyleAuto(text) {
  const t = (text || "").toLowerCase();
  const short = t.split(/\s+/).filter(Boolean).length <= 6;
  const slang = /(—á–µ|—á–æ|–∏–∑–∏|—Ç–æ–ø—á–∏–∫|–≥–æ|–Ω–æ—Ä–º–∞—Å|–ª—é—Ç—ã–π|—á–µ–ª|–±—Ä–æ|–ª–æ–ª|–∞—Ö–∞—Ö)/.test(t);
  const polite = /(–ø–æ–∂–∞–ª—É–π—Å—Ç–∞|–Ω–µ –º–æ–≥–ª–∏ –±—ã|–±—É–¥—å—Ç–µ –¥–æ–±—Ä—ã|–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ)/.test(t) || /(^|\s)–≤—ã(\s|$)/.test(t);
  if (polite && !slang) return "formal";
  if (slang || short) return "friendly";
  return "formal";
}
function applyStyleLock(autoStyle, styleLock) {
  if (styleLock === "friendly" || styleLock === "formal") return styleLock;
  return autoStyle;
}

/* ---------- WEATHER utils ---------- */
// –ß–∞—Å—Ç—ã–µ –≥–æ—Ä–æ–¥–∞: —Ñ–æ—Ä–º—ã ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞
const CITY_FORMS = new Map([
  // –ú–æ—Å–∫–≤–∞
  ["–º–æ—Å–∫–≤–µ","–º–æ—Å–∫–≤–∞"],["–º–æ—Å–∫–æ–≤","–º–æ—Å–∫–≤–∞"],
  // –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥
  ["—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥–µ","—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥"],["–ø–∏—Ç–µ—Ä–µ","—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥"],["–ø–∏—Ç–µ—Ä","—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥"],
  // –ù—å—é-–ô–æ—Ä–∫
  ["–Ω—å—é-–π–æ—Ä–∫–µ","–Ω—å—é-–π–æ—Ä–∫"],["–Ω—å—é –π–æ—Ä–∫–µ","–Ω—å—é-–π–æ—Ä–∫"],["–Ω—å—é –π–æ—Ä–∫","–Ω—å—é-–π–æ—Ä–∫"],
  // –¢–æ–∫–∏–æ
  ["—Ç–æ–∫–∏–æ","—Ç–æ–∫–∏–æ"],
  // –ü–∞—Ä–∏–∂
  ["–ø–∞—Ä–∏–∂–µ","–ø–∞—Ä–∏–∂"],
  // –†–∏–º
  ["—Ä–∏–º–µ","—Ä–∏–º"],
  // –ë–µ—Ä–ª–∏–Ω
  ["–±–µ—Ä–ª–∏–Ω–µ","–±–µ—Ä–ª–∏–Ω"],
  // –õ–æ–Ω–¥–æ–Ω / –ê–Ω–≥–ª–∏—è
  ["–ª–æ–Ω–¥–æ–Ω–µ","–ª–æ–Ω–¥–æ–Ω"],
  // –ú–µ—Ö–∏–∫–æ
  ["–º–µ—Ö–∏–∫–æ","–º–µ—Ö–∏–∫–æ"],
  // –ü–µ–∫–∏–Ω
  ["–ø–µ–∫–∏–Ω–µ","–ø–µ–∫–∏–Ω"],
  // –°—Ç–∞–º–±—É–ª
  ["—Å—Ç–∞–º–±—É–ª–µ","—Å—Ç–∞–º–±—É–ª"],
  // –ê–Ω–∫–∞—Ä–∞
  ["–∞–Ω–∫–∞—Ä–µ","–∞–Ω–∫–∞—Ä–∞"],
  // –ú–∞–¥—Ä–∏–¥
  ["–º–∞–¥—Ä–∏–¥–µ","–º–∞–¥—Ä–∏–¥"]
]);

// –°—Ç—Ä–∞–Ω—ã ‚Üí —Å—Ç–æ–ª–∏—Ü—ã (–∏–ª–∏ —Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ç–∏–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞)
const COUNTRY_TO_CAPITAL = new Map([
  ["—Ä–æ—Å—Å–∏—è","–º–æ—Å–∫–≤–∞"],
  ["—É–∫—Ä–∞–∏–Ω–∞","–∫–∏–µ–≤"],
  ["–∏—Ç–∞–ª–∏—è","—Ä–∏–º"],
  ["—è–ø–æ–Ω–∏—è","—Ç–æ–∫–∏–æ"],
  ["–∫–∏—Ç–∞–π","–ø–µ–∫–∏–Ω"],
  ["–≥–µ—Ä–º–∞–Ω–∏—è","–±–µ—Ä–ª–∏–Ω"],
  ["—Ñ—Ä–∞–Ω—Ü–∏—è","–ø–∞—Ä–∏–∂"],
  ["–∏—Å–ø–∞–Ω–∏—è","–º–∞–¥—Ä–∏–¥"],
  ["–ø–æ—Ä—Ç—É–≥–∞–ª–∏—è","–ª–∏—Å—Å–∞–±–æ–Ω"],
  ["–≤–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è","–ª–æ–Ω–¥–æ–Ω"],["–∞–Ω–≥–ª–∏—è","–ª–æ–Ω–¥–æ–Ω"],["–±—Ä–∏—Ç–∞–Ω–∏—è","–ª–æ–Ω–¥–æ–Ω"],["uk","–ª–æ–Ω–¥–æ–Ω"],["united kingdom","–ª–æ–Ω–¥–æ–Ω"],
  ["—Å—à–∞","–≤–∞—à–∏–Ω–≥—Ç–æ–Ω"],["—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —à—Ç–∞—Ç—ã","–≤–∞—à–∏–Ω–≥—Ç–æ–Ω"],["—Å–æ–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —à—Ç–∞—Ç—ã","–≤–∞—à–∏–Ω–≥—Ç–æ–Ω"],["—à—Ç–∞—Ç—ã","–≤–∞—à–∏–Ω–≥—Ç–æ–Ω"],["–∞–º–µ—Ä–∏–∫–∞","–Ω—å—é-–π–æ—Ä–∫"], // ¬´–ê–º–µ—Ä–∏–∫–∞¬ª –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ ‚Äî –±–µ—Ä—ë–º –ù—å—é-–ô–æ—Ä–∫
  ["–∫–∞–Ω–∞–¥–∞","–æ—Ç—Ç–∞–≤–∞"],
  ["–º–µ–∫—Å–∏–∫–∞","–º–µ—Ö–∏–∫–æ"],
  ["—Ç—É—Ä—Ü–∏—è","–∞–Ω–∫–∞—Ä–∞"],
  ["–ø–æ–ª—å—à–∞","–≤–∞—Ä—à–∞–≤–∞"],
  ["–∫—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω","–±–∏—à–∫–µ–∫"],["–∫–∞–∑–∞—Ö—Å—Ç–∞–Ω","–∞—Å—Ç–∞–Ω–∞"],["—É–∑–±–µ–∫–∏—Å—Ç–∞–Ω","—Ç–∞—à–∫–µ–Ω—Ç"],
  ["—á–µ—Ö–∏—è","–ø—Ä–∞–≥–∞"],["—à–≤–µ—Ü–∏—è","—Å—Ç–æ–∫–≥–æ–ª—å–º"],["–Ω–æ—Ä–≤–µ–≥–∏—è","–æ—Å–ª–æ"],["—Ñ–∏–Ω–ª—è–Ω–¥–∏—è","—Ö–µ–ª—å—Å–∏–Ω–∫–∏"]
]);

function tidyPlace(raw){
  if (!raw) return null;
  let s = raw.toLowerCase().trim();
  // —Å—Ä–µ–∑–∞—Ç—å —Ö–≤–æ—Å—Ç–æ–≤—ã–µ –∑–Ω–∞–∫–∏
  s = s.replace(/[.,!?;:()¬´¬ª"'`]+$/g, "").trim();
  // —É–±—Ä–∞—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞
  s = s.replace(/\b(–≥–æ—Ä–æ–¥|—Å—Ç—Ä–∞–Ω–∞|–≤\s+–≥–æ—Ä–æ–¥–µ|–≤\s+—Å—Ç—Ä–∞–Ω–µ)\b/g, "").trim();
  // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Å—Ç—ã—Ö —Ñ–æ—Ä–º
  if (CITY_FORMS.has(s)) return CITY_FORMS.get(s);
  // –ø–æ–ø—ã—Ç–∫–∞ –≤—ã–∫–∏–Ω—É—Ç—å –æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–Ω–æ–≥–æ/—Ä–æ–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª–æ–≤ (–º—è–≥–∫–æ)
  s = s.replace(/(–µ|–∏|—É|—é|–æ–π|–µ–π|–∏–∏|–∏–π|–∞—è|—ã–µ|–æ–º|—ã–º|–∞–º|—è–º)$/i, "");
  return s.trim();
}

function extractPlace(query){
  const q = normalizeText(query);
  // "–ø–æ–≥–æ–¥–∞ –≤ <...>" / "–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞ –≤ <...>" / "–ø—Ä–æ–≥–Ω–æ–∑ –≤ <...>"
  let m = q.match(/–ø–æ–≥–æ–¥[–∞–µ—ã]?\s+(–≤|–≤–æ)\s+(.+)/);
  if (m) return tidyPlace(m[2]);
  m = q.match(/–ø—Ä–æ–≥–Ω–æ–∑\s+(–≤|–≤–æ)\s+(.+)/);
  if (m) return tidyPlace(m[2]);
  // "<–ø–æ–≥–æ–¥–∞> –≤ <...> —Å–µ–π—á–∞—Å/—Å–µ–≥–æ–¥–Ω—è"
  m = q.match(/(–≤|–≤–æ)\s+([a-z–∞-—è—ë\-\s]+)\s+(—Å–µ–π—á–∞—Å|—Å–µ–≥–æ–¥–Ω—è)/i);
  if (m) return tidyPlace(m[2]);
  // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø–æ—Å–ª–µ "–≤ " –¥–æ –∫–æ–Ω—Ü–∞
  m = q.match(/\b(–≤|–≤–æ)\s+([a-z–∞-—è—ë0-9\-\s]+)$/i);
  if (m) return tidyPlace(m[2]);
  // –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ ‚Äî —Ç—Ä–∞–∫—Ç—É–µ–º –∫–∞–∫ –º–µ—Å—Ç–æ
  if (/–ø–æ–≥–æ–¥|—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä|–¥–æ–∂–¥|—Å–Ω–µ–≥|–ø—Ä–æ–≥–Ω–æ–∑/.test(q)) {
    const tail = q.replace(/(–∫–∞–∫–∞—è|–∫–∞–∫–æ–π|—Ç–µ–∫—É—â–∞—è|—Å–µ–π—á–∞—Å|—Å–µ–≥–æ–¥–Ω—è|–ø–æ–≥–æ–¥–∞|–ø—Ä–æ–≥–Ω–æ–∑|–≤|–≤–æ)/g," ").replace(/\s+/g," ").trim();
    if (tail) return tidyPlace(tail);
  }
  return null;
}

async function geocode(place){
  const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(place)}&count=1&language=ru&format=json`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`Geocode ${r.status}`);
  const j = await r.json();
  const loc = j.results?.[0];
  if (!loc) return null;
  return {
    name: loc.name,
    admin1: loc.admin1 || "",
    country: loc.country || "",
    lat: loc.latitude,
    lon: loc.longitude
  };
}
async function forecast(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
  const r = await fetch(url);
  if (!r.ok) throw new Error(`Forecast ${r.status}`);
  return r.json();
}
const WMO = {
  0:"—è—Å–Ω–æ",1:"–≤ –æ—Å–Ω–æ–≤–Ω–æ–º —è—Å–Ω–æ",2:"–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å",3:"–ø–∞—Å–º—É—Ä–Ω–æ",
  45:"—Ç—É–º–∞–Ω",48:"–∏–∑–º–æ—Ä–æ–∑—å",51:"–ª—ë–≥–∫–∞—è –º–æ—Ä–æ—Å—å",53:"–º–æ—Ä–æ—Å—å",55:"—Å–∏–ª—å–Ω–∞—è –º–æ—Ä–æ—Å—å",
  56:"–ª–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å",57:"—Å–∏–ª—å–Ω–∞—è –ª–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å",
  61:"–Ω–µ–±–æ–ª—å—à–æ–π –¥–æ–∂–¥—å",63:"–¥–æ–∂–¥—å",65:"—Å–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å",
  66:"–ª–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å",67:"—Å–∏–ª—å–Ω—ã–π –ª–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å",
  71:"–Ω–µ–±–æ–ª—å—à–æ–π —Å–Ω–µ–≥",73:"—Å–Ω–µ–≥",75:"—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥",
  77:"—Å–Ω–µ–∂–Ω—ã–µ –∑—ë—Ä–Ω–∞",80:"–ª–∏–≤–Ω–∏",81:"—Å–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏",82:"–æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã–µ –ª–∏–≤–Ω–∏",
  85:"—Å–Ω–µ–≥–æ–ø–∞–¥",86:"—Å–∏–ª—å–Ω—ã–π —Å–Ω–µ–≥–æ–ø–∞–¥",95:"–≥—Ä–æ–∑–∞",96:"–≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º",99:"—Å–∏–ª—å–Ω–∞—è –≥—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º"
};

/* ---------- intents ---------- */
function detectIntent(query) {
  const q = normalizeText(query);
  if (!q) return "EMPTY";
  const words = q.split(/\s+/).filter(Boolean);
  const hasQ = /[?]/.test(q) || /(–∫—Ç–æ|—á—Ç–æ|–≥–¥–µ|–∫–æ–≥–¥–∞|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º|–∫–∞–∫|—Å–∫–æ–ª—å–∫–æ)/.test(q);

  if (hasAnyToken(q, ["–ø—Ä–∏–≤–µ—Ç","–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π","–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ","–π–æ","—Ö–∞–π","–ø—Ä–∏–≤","–¥–∞—Ä–æ–≤–∞"])) return "GREETING";
  if (hasAnyToken(q, ["–∫–∞–∫ –¥–µ–ª–∞","—á—Ç–æ –Ω–æ–≤–æ–≥–æ","–∫–∞–∫ —Ç—ã","–∫–∞–∫ –∂–∏–∑–Ω—å"])) return "HOW_ARE_YOU";
  if (hasAnyToken(q, ["—Å–ø–∞—Å–∏–±–æ","–±–ª–∞–≥–æ–¥–∞—Ä—é","–º–µ—Ä—Å–∏"])) return "THANKS";
  if (hasAnyToken(q, ["–ø–æ–∫–∞","–¥–æ –≤—Å—Ç—Ä–µ—á–∏","—É–≤–∏–¥–∏–º—Å—è","–±–∞–π"])) return "BYE";
  if (hasPhrase(q,"—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏") || hasPhrase(q,"—Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º—è") || hasAnyToken(q,["–∫–æ—Ç–æ—Ä—ã–π —á–∞—Å"]) || hasAnyToken(q,["–≤—Ä–µ–º—è"])) return "TIME";

  if (/–ø–æ–≥–æ–¥|—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä|–¥–æ–∂–¥|—Å–Ω–µ–≥|–ø—Ä–æ–≥–Ω–æ–∑/.test(q)) return "WEATHER";

  if (hasAnyToken(q, ["–Ω–æ–≤–æ—Å—Ç–∏","—Ç—Ä–µ–Ω–¥—ã","—Å–∏—Ç—É–∞—Ü–∏—è","–æ–±—ä—è—Å–Ω–∏","google","–±—Ä–∞—É–∑–µ—Ä"]) ||
      hasPhrase(q,"—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ") || hasPhrase(q,"—Ä–∞—Å—Å–∫–∞–∂–∏ –æ–±") || hasAnyToken(q,["–Ω–∞–π–¥–∏","–ø–æ–∏—â–∏","–≤ –≥—É–≥–ª–µ","–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ"])) {
    return "WEB_SEARCH";
  }
  if (hasQ && words.length >= 4) return "WEB_SEARCH";
  if (words.length <= 3) return "SMALL_TALK";
  return "GENERAL_CHAT";
}

/* ---------- search (Brave) ---------- */
function getKey() {
  const k = (process.env.BRAVE_KEY || "").trim();
  const ascii = /^[\x00-\x7F]*$/.test(k);
  return { k, ascii, len: k.length };
}
async function braveSearch(q) {
  const { k, ascii } = getKey();
  if (!k || !ascii) return { disabled: true, items: [] };
  const url = `https://api.search.brave.com/res/v1/web/search?q=${encodeURIComponent(q)}&count=3&freshness=day`;
  const res = await fetch(url, { headers: { "X-Subscription-Token": k } });
  if (!res.ok) {
    const body = await res.text().catch(()=> "");
    throw new Error(`Brave API ${res.status}: ${body}`);
  }
  const data = await res.json();
  const items = (data.web?.results ?? []).map(r => ({
    title: r.title, url: r.url, snippet: r.snippet || r.description || ""
  }));
  return { disabled: false, items };
}

/* ---------- routes ---------- */
app.get("/healthz", (_req,res)=>res.json({ok:true,time:new Date().toISOString()}));
app.get("/api/meta", (_req,res)=>{
  const k = getKey();
  res.json({ status:"online", web_search_enabled: !!(k.k && k.ascii) });
});

app.post("/api/assist", async (req,res)=>{
  try{
    const query = (req.body?.query || "").trim();
    const styleLock = (req.body?.styleLock || "auto");
    if (!query) return res.status(400).json({ reply: "–ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å.", style: "formal" });

    const intent = detectIntent(query);
    const autoStyle = detectStyleAuto(query);
    const style = applyStyleLock(autoStyle, styleLock);

    console.log(`[assist] intent=${intent} style=${style} query="${query}"`);

    if (intent === "GREETING")
      return res.json({ reply: style==="friendly"?"–ô–æ! üëã –†–∞–¥ —Ç–µ–±—è –≤–∏–¥–µ—Ç—å üòé":"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!", style });
    if (intent === "HOW_ARE_YOU")
      return res.json({ reply: style==="friendly"?"–î–∞ –Ω–æ—Ä–º–∞—Å, –≤—Å—ë —á—ë—Ç–∫–æ üòé –ê —É —Ç–µ–±—è –∫–∞–∫?":"–£ –º–µ–Ω—è –≤—Å—ë —Ö–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ. –ö–∞–∫ —É –≤–∞—Å –¥–µ–ª–∞?", style });
    if (intent === "THANKS")
      return res.json({ reply: style==="friendly"?"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üôå":"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞.", style });
    if (intent === "BYE")
      return res.json({ reply: style==="friendly"?"–î–æ —Å–≤—è–∑–∏! üëã":"–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!", style });
    if (intent === "TIME") {
      const now = new Date().toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"});
      return res.json({ reply: style==="friendly"?`–ë—Ä–æ, —Å–µ–π—á–∞—Å ${now} üòâ`:`–°–µ–π—á–∞—Å ${now}.`, style });
    }

    if (intent === "WEATHER") {
      // 1) –∏–∑–≤–ª–µ—á—å –º–µ—Å—Ç–æ
      const raw = extractPlace(query);
      // 2) –µ—Å–ª–∏ —Å–∫–∞–∑–∞–ª–∏ —Å—Ç—Ä–∞–Ω—É ‚Äî –±–µ—Ä—ë–º —Å—Ç–æ–ª–∏—Ü—É/—Ä–µ–ø—Ä–µ–∑–µ–Ω—Ç –≥–æ—Ä–æ–¥
      let place = raw;
      if (place && COUNTRY_TO_CAPITAL.has(place)) place = COUNTRY_TO_CAPITAL.get(place);
      // 3) –µ—Å–ª–∏ –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ ‚Äî –ø–æ–¥–º–µ–Ω–∏–º
      if (place && CITY_FORMS.has(place)) place = CITY_FORMS.get(place);

      // 4) –µ—Å–ª–∏ –Ω–µ –¥–æ—Å—Ç–∞–ª–∏ ‚Äî –ø–æ–¥—Å–∫–∞–∂–µ–º —Ñ–æ—Ä–º–∞—Ç
      if (!place) {
        const ask = style==="friendly" ? "–°–∫–∞–∂–∏ –≥–æ—Ä–æ–¥: ¬´–ø–æ–≥–æ–¥–∞ –≤ –¢–æ–∫–∏–æ¬ª" : "–£—Ç–æ—á–Ω–∏—Ç–µ –≥–æ—Ä–æ–¥: ¬´–ø–æ–≥–æ–¥–∞ –≤ –¢–æ–∫–∏–æ¬ª.";
        return res.json({ reply: ask, style });
      }

      // 5) –≥–µ–æ–∫–æ–¥
      let loc = await geocode(place);
      // –µ—Å–ª–∏ –≥–µ–æ–∫–æ–¥ –ø–æ —Å—Ç—Ä–∞–Ω–µ/—Ñ–æ—Ä–º–µ –Ω–µ –Ω–∞—à—ë–ª ‚Äî –ø–æ–ø—Ä–æ–±—É–µ–º —Å—Ç–æ–ª–∏—Ü—É –ø–æ —Å–ª–æ–≤–∞—Ä—é
      if (!loc && COUNTRY_TO_CAPITAL.has(place)) {
        loc = await geocode(COUNTRY_TO_CAPITAL.get(place));
      }
      if (!loc) {
        const msg = style==="friendly" ? `–ù–µ –Ω–∞—à—ë–ª –ª–æ–∫–∞—Ü–∏—é ¬´${place}¬ª üòÖ` : `–õ–æ–∫–∞—Ü–∏—è ¬´${place}¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`;
        return res.json({ reply: msg, style });
      }

      // 6) –ø—Ä–æ–≥–Ω–æ–∑
      const fc = await forecast(loc.lat, loc.lon);
      const cur = fc.current_weather || {};
      const w = WMO[cur.weathercode] || "–ø–æ–≥–æ–¥–∞";
      const t = typeof cur.temperature === "number" ? Math.round(cur.temperature) : null;
      const wind = typeof cur.windspeed === "number" ? Math.round(cur.windspeed) : null;

      const label = [loc.name, loc.admin1, loc.country].filter(Boolean).join(", ");
      const line = style==="friendly"
        ? `–í ${label} —Å–µ–π—á–∞—Å ${t!==null?`${t}¬∞C`: "‚Äî"} (${w}). –í–µ—Ç–µ—Ä ${wind!==null?`${wind} –º/—Å`:"‚Äî"}.`
        : `–°–µ–π—á–∞—Å –≤ ${label}: ${t!==null?`${t}¬∞C`: "‚Äî"} (${w}). –í–µ—Ç–µ—Ä ${wind!==null?`${wind} –º/—Å`:"‚Äî"}.`;

      const src = `https://open-meteo.com/`;
      return res.json({ reply: `${line}\n–ò—Å—Ç–æ—á–Ω–∏–∫: ${src}`, style, actions:[{ type:"open_url", url: src }] });
    }

    if (intent === "SMALL_TALK")
      return res.json({ reply: style==="friendly"?"–ü–æ–Ω—è–ª üëç –°–ø—Ä–æ—Å–∏ —á—Ç–æ-—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ–µ.":"–ü–æ–Ω–∏–º–∞—é. –£—Ç–æ—á–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.", style });

    if (intent === "GENERAL_CHAT")
      return res.json({ reply: style==="friendly"?"–û–∫–µ–π, –ø–æ–Ω—è–ª —Ç–µ–±—è. –ú–æ–≥—É –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–∫—Ç–æ–≤ –∏–ª–∏ —Å—Å—ã–ª–æ–∫, –µ—Å–ª–∏ –Ω–∞–¥–æ üòâ":"–ü–æ–Ω–∏–º–∞—é. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ, –º–æ–≥—É –¥–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É –∏–ª–∏ —Å—Å—ã–ª–∫–∏.", style });

    // WEB_SEARCH
    const { disabled, items } = await braveSearch(normalizeText(query));
    if (disabled) return res.json({ reply: "–ü–æ–∏—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–∫–ª—é—á –Ω–µ –∑–∞–¥–∞–Ω/–Ω–µ ASCII).", style });
    if (!items.length) return res.json({ reply: `–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ ¬´${query}¬ª.`, style });

    const top = items[0];
    return res.json({ reply: `${top.snippet || ""}\n–ü–æ–¥—Ä–æ–±–Ω–µ–µ: ${top.url}`, style, actions:[{type:"open_url",url:top.url}] });

  } catch(e) {
    console.error(e);
    return res.status(500).json({ reply:"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.", style:"formal" });
  }
});

/* ---------- start ---------- */
app.listen(PORT, ()=> {
  const k = getKey();
  console.log(`BRAVE len=${k.len} ascii=${k.ascii}`);
  console.log(`‚úÖ Server ready: http://localhost:${PORT}`);
  console.log(`üîé Health:  http://localhost:${PORT}/healthz`);
  console.log(`‚ÑπÔ∏è  Meta:    http://localhost:${PORT}/api/meta`);
});
